<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‰∏ªÈ°µÁºñËæëÂô® ‚úèÔ∏è</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="assets/css/style.css">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="bg-gray-50">
    <div id="app" class="h-screen flex flex-col md:flex-row overflow-hidden">
        
        <!-- Sidebar: Editor Controls -->
        <div class="w-full md:w-1/3 bg-white border-r border-gray-200 flex flex-col h-full shadow-lg z-20">
            <div class="p-6 border-b border-gray-100 bg-pink-50">
                <h1 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                    <i data-lucide="edit-3" class="w-5 h-5"></i> ÁºñËæëÊàëÁöÑ‰∏ªÈ°µ
                </h1>
                <p class="text-xs text-gray-500 mt-1">‰øÆÊîπÂêéÁÇπÂáª‰øùÂ≠òÔºåÊõøÊç¢ data/profile.json Êñá‰ª∂</p>
            </div>

            <div class="flex-1 overflow-y-auto p-6 space-y-8">
                
                <!-- Basic Info Section -->
                <section>
                    <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-4">Âü∫Êú¨‰ø°ÊÅØ</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ÊòµÁß∞</label>
                            <input v-model="profile.basicInfo.nickname" type="text" class="w-full px-4 py-2 rounded-lg border border-gray-200 focus:ring-2 focus:ring-pink-200 focus:border-pink-300 outline-none transition-all">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Â§¥ÂÉè</label>
                            <div class="flex gap-2">
                                <input v-model="profile.basicInfo.avatar" type="text" placeholder="ËæìÂÖ•ÂõæÁâáURL" class="flex-1 px-4 py-2 rounded-lg border border-gray-200 focus:ring-2 focus:ring-pink-200 outline-none transition-all text-sm">
                                <label class="cursor-pointer bg-pink-100 hover:bg-pink-200 text-pink-500 px-3 py-2 rounded-lg flex items-center justify-center transition-colors">
                                    <i data-lucide="upload" class="w-4 h-4"></i>
                                    <input type="file" accept="image/*" class="hidden" @change="handleAvatarUpload">
                                </label>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">‰∏™ÊÄßÁ≠æÂêç</label>
                            <textarea v-model="profile.basicInfo.signature" rows="2" class="w-full px-4 py-2 rounded-lg border border-gray-200 focus:ring-2 focus:ring-pink-200 outline-none transition-all"></textarea>
                        </div>
                    </div>
                </section>

                <!-- Hobbies Section -->
                <section>
                    <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-4 flex justify-between items-center">
                        Áà±Â•ΩÊ†áÁ≠æ
                        <button @click="addHobby" class="text-xs bg-gray-100 hover:bg-gray-200 px-2 py-1 rounded transition-colors">+ Ê∑ªÂä†</button>
                    </h3>
                    <div class="space-y-2">
                        <div v-for="(hobby, index) in profile.hobbies" :key="index" class="flex gap-2">
                            <input v-model="profile.hobbies[index]" type="text" class="flex-1 px-3 py-2 rounded-lg border border-gray-200 focus:ring-2 focus:ring-pink-200 outline-none text-sm">
                            <button @click="removeHobby(index)" class="text-red-400 hover:text-red-600 p-2">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                </section>

                <!-- Moods Section -->
                <section>
                    <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-4 flex justify-between items-center">
                        ÂøÉÊÉÖÂ¢ô
                        <button @click="addMood" class="text-xs bg-gray-100 hover:bg-gray-200 px-2 py-1 rounded transition-colors">+ ÂÜôÂøÉÊÉÖ</button>
                    </h3>
                    <div class="space-y-4">
                        <div v-for="(mood, index) in profile.moods" :key="mood.id" class="p-4 bg-gray-50 rounded-xl border border-gray-100">
                            <div class="flex justify-between mb-2">
                                <span class="text-xs font-mono text-gray-400">#{{ index + 1 }}</span>
                                <button @click="removeMood(index)" class="text-red-400 hover:text-red-600">
                                    <i data-lucide="x" class="w-4 h-4"></i>
                                </button>
                            </div>
                            <textarea v-model="mood.content" rows="2" class="w-full px-3 py-2 rounded-lg border border-gray-200 mb-2 text-sm" placeholder="‰ªäÂ§©ÂèëÁîü‰∫Ü‰ªÄ‰πà..."></textarea>
                            <div class="flex gap-2">
                                <input v-model="mood.date" type="date" class="w-1/2 px-3 py-1 rounded-lg border border-gray-200 text-xs">
                                <select v-model="mood.color" class="w-1/2 px-3 py-1 rounded-lg border border-gray-200 text-xs">
                                    <option value="bg-pink-100">Á≤âËâ≤</option>
                                    <option value="bg-blue-100">ËìùËâ≤</option>
                                    <option value="bg-yellow-100">ÈªÑËâ≤</option>
                                    <option value="bg-green-100">ÁªøËâ≤</option>
                                    <option value="bg-purple-100">Á¥´Ëâ≤</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </section>

            </div>

            <!-- Footer Actions -->
            <div class="p-6 border-t border-gray-200 bg-white">
                <button @click="saveProfile" class="w-full bg-gray-900 hover:bg-gray-800 text-white font-bold py-3 px-4 rounded-xl shadow-lg transform active:scale-95 transition-all flex justify-center items-center gap-2">
                    <i data-lucide="download" class="w-5 h-5"></i>
                    ‰øùÂ≠òÈÖçÁΩÆ (profile.json)
                </button>
            </div>
        </div>

        <!-- Main: Live Preview -->
        <div class="flex-1 bg-gray-100 overflow-y-auto relative">
            <div class="absolute top-4 right-4 bg-white/80 backdrop-blur px-3 py-1 rounded-full text-xs font-bold text-gray-500 shadow-sm z-10 pointer-events-none">
                LIVE PREVIEW
            </div>
            
            <!-- Reusing the exact structure from index.html for fidelity -->
            <div class="min-h-screen p-8 flex justify-center items-start transform scale-90 origin-top">
                <div class="w-full max-w-4xl grid grid-cols-1 md:grid-cols-3 gap-6">
                    
                    <!-- Left Sidebar: Profile -->
                    <div class="md:col-span-1 space-y-6">
                        <div class="glass-card rounded-3xl p-6 text-center kawaii-shadow relative overflow-hidden">
                            <div class="absolute top-0 left-0 w-full h-24 bg-pink-100 opacity-50"></div>
                            
                            <div class="relative z-10 mt-4">
                                <img :src="profile.basicInfo.avatar" alt="Avatar" 
                                     class="w-32 h-32 rounded-full mx-auto border-4 border-white shadow-md object-cover">
                                
                                <h1 class="text-2xl font-bold mt-4 text-gray-800">{{ profile.basicInfo.nickname || '‰Ω†ÁöÑÂêçÂ≠ó' }}</h1>
                                <p class="text-sm text-gray-500 mt-2 px-2">{{ profile.basicInfo.signature || 'ÂÜô‰∏ÄÂè•Á≠æÂêçÂêß...' }}</p>
                            </div>
        
                            <div class="mt-6 flex justify-center gap-3">
                                <div class="p-2 bg-pink-50 text-pink-400 rounded-full"><i data-lucide="heart" class="w-5 h-5"></i></div>
                                <div class="p-2 bg-blue-50 text-blue-400 rounded-full"><i data-lucide="message-circle" class="w-5 h-5"></i></div>
                                <div class="p-2 bg-purple-50 text-purple-400 rounded-full"><i data-lucide="share-2" class="w-5 h-5"></i></div>
                            </div>
                        </div>
        
                        <!-- Hobbies Section -->
                        <div class="glass-card rounded-3xl p-6 kawaii-shadow">
                            <h2 class="text-lg font-bold text-gray-700 mb-4 flex items-center gap-2">
                                <i data-lucide="star" class="w-5 h-5 text-yellow-400"></i>
                                ÊàëÁöÑÁà±Â•Ω
                            </h2>
                            <div class="flex flex-wrap gap-2">
                                <span v-for="(hobby, index) in profile.hobbies" :key="index"
                                      class="px-3 py-1 bg-white border border-gray-100 rounded-full text-sm text-gray-600 shadow-sm">
                                    {{ hobby }}
                                </span>
                            </div>
                        </div>
                    </div>
        
                    <!-- Right Content: Mood Wall -->
                    <div class="md:col-span-2">
                        <div class="glass-card rounded-3xl p-6 kawaii-shadow h-full">
                            <h2 class="text-xl font-bold text-gray-700 mb-6 flex items-center gap-2">
                                <i data-lucide="cloud" class="w-6 h-6 text-blue-400"></i>
                                ÂøÉÊÉÖ‰æøÂà©Ë¥¥
                            </h2>
                            
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div v-for="mood in profile.moods" :key="mood.id"
                                     :class="['p-4 rounded-2xl transition-all duration-300 shadow-sm', mood.color || 'bg-white']">
                                    <div class="flex justify-between items-start mb-2">
                                        <span class="text-xs text-gray-500 font-medium bg-white/50 px-2 py-1 rounded-lg">
                                            {{ mood.date }}
                                        </span>
                                        <i data-lucide="pin" class="w-4 h-4 text-gray-400 opacity-50"></i>
                                    </div>
                                    <p class="text-gray-700 leading-relaxed">{{ mood.content }}</p>
                                </div>
                            </div>
                        </div>
                    </div>
        
                </div>
            </div>
        </div>

    </div>

    <script>
        const { createApp, ref, onMounted, nextTick, watch } = Vue;

        createApp({
            setup() {
                const profile = ref({
                    basicInfo: { nickname: '', avatar: '', signature: '' },
                    hobbies: [],
                    moods: []
                });

                // Load initial data
                const fetchData = async () => {
                    try {
                        // First check local storage for drafts
                        const localData = localStorage.getItem('sakura_profile_draft');
                        if (localData) {
                            console.log('Loaded from LocalStorage');
                            profile.value = JSON.parse(localData);
                            return;
                        }

                        const response = await fetch('data/profile.json?t=' + new Date().getTime());
                        if (response.ok) {
                            profile.value = await response.json();
                            // Sync to local storage
                            localStorage.setItem('sakura_profile_draft', JSON.stringify(profile.value));
                        }
                    } catch (e) {
                        console.log('Using default template');
                        profile.value = {
                            basicInfo: { nickname: 'Momo', avatar: '', signature: 'Hello World' },
                            hobbies: ['Coding'],
                            moods: []
                        };
                    }
                };

                const handleAvatarUpload = async (event) => {
                    const file = event.target.files[0];
                    if (!file) return;

                    // Limit file size to 5MB
                    if (file.size > 5 * 1024 * 1024) {
                        alert('ÂõæÁâáÂ§™Â§ß‰∫ÜÔºÅËØ∑‰∏ä‰º†Â∞è‰∫é 5MB ÁöÑÂõæÁâá üò£');
                        return;
                    }

                    // 1. Try to upload to server (COS)
                    const formData = new FormData();
                    formData.append('file', file);

                    try {
                        const apiUrl = window.location.hostname === 'localhost' 
                            ? 'http://localhost:3000/api/upload' 
                            : '/api/upload';

                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            body: formData
                        });

                        const result = await response.json();
                        
                        if (result.success && result.url) {
                            profile.value.basicInfo.avatar = result.url;
                            alert('Â§¥ÂÉè‰∏ä‰º†ÊàêÂäüÔºÅ‚ú®');
                        } else {
                            throw new Error(result.message || 'Upload failed');
                        }
                    } catch (err) {
                        console.warn('Server upload failed, falling back to Base64:', err);
                        
                        // 2. Fallback: Local Base64 (if server upload fails)
                        if (confirm('ÊúçÂä°Âô®‰∏ä‰º†Â§±Ë¥• (ÂèØËÉΩÊòØÊú™ÈÖçÁΩÆ COS)ÔºåÊòØÂê¶ËΩ¨‰∏∫Êú¨Âú∞ Base64 Â≠òÂÇ®Ôºü\n(Ê≥®ÊÑèÔºöBase64 ‰ºöËÆ©Êñá‰ª∂ÂèòÂ§ßÔºåÂΩ±ÂìçÂä†ËΩΩÈÄüÂ∫¶)')) {
                             const reader = new FileReader();
                             reader.onload = (e) => {
                                 profile.value.basicInfo.avatar = e.target.result;
                             };
                             reader.readAsDataURL(file);
                        }
                    }
                };

                const addHobby = () => profile.value.hobbies.push('Êñ∞Áà±Â•Ω');
                const removeHobby = (index) => profile.value.hobbies.splice(index, 1);
                
                const addMood = () => {
                    const today = new Date().toISOString().split('T')[0];
                    profile.value.moods.unshift({
                        id: Date.now(),
                        content: '',
                        date: today,
                        color: 'bg-pink-100'
                    });
                };
                const removeMood = (index) => profile.value.moods.splice(index, 1);

                const saveProfile = async () => {
                    // 1. Save to LocalStorage (Backup)
                    localStorage.setItem('sakura_profile_draft', JSON.stringify(profile.value));

                    try {
                        // 2. Try to save to server via API
                        // Note: In development (localhost:8080), we need to point to port 3000
                        // In production (nginx), /api/save will be proxied correctly
                        const apiUrl = window.location.hostname === 'localhost' 
                            ? 'http://localhost:3000/api/save' 
                            : '/api/save';

                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(profile.value)
                        });

                        const result = await response.json();
                        
                        if (result.success) {
                            alert('‰øùÂ≠òÊàêÂäüÔºÅüéâ\nÊúçÂä°Âô®Êï∞ÊçÆÂ∑≤Êõ¥Êñ∞ÔºåÁΩëÁ´ôÂÜÖÂÆπÂ∑≤ÂêåÊ≠•„ÄÇ');
                        } else {
                            throw new Error(result.message || 'Server error');
                        }
                    } catch (err) {
                        console.error('Save failed:', err);
                        
                        // 3. Fallback: File System / Download
                        if (confirm('ËøûÊé•ÊúçÂä°Âô®‰øùÂ≠òÂ§±Ë¥•ÔºàÂèØËÉΩÊòØÊú¨Âú∞ÂºÄÂèëÁéØÂ¢ÉÊú™ÂêØÂä® API ÊúçÂä°Ôºâ„ÄÇ\nÊòØÂê¶‰∏ãËΩΩ JSON Êñá‰ª∂ÊâãÂä®‰øùÂ≠òÔºü')) {
                             const dataStr = JSON.stringify(profile.value, null, 2);
                             const blob = new Blob([dataStr], { type: "application/json" });
                             const url = URL.createObjectURL(blob);
                             const a = document.createElement('a');
                             a.href = url;
                             a.download = "profile.json";
                             document.body.appendChild(a);
                             a.click();
                             document.body.removeChild(a);
                             URL.revokeObjectURL(url);
                        }
                    }
                };

                onMounted(() => {
                    fetchData();
                });

                // Auto-save to localStorage on changes
                watch(profile, (newVal) => {
                    localStorage.setItem('sakura_profile_draft', JSON.stringify(newVal));
                    nextTick(() => lucide.createIcons());
                }, { deep: true });

                return {
                    profile,
                    addHobby,
                    removeHobby,
                    addMood,
                    removeMood,
                    saveProfile
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
